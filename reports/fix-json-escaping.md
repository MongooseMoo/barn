# Fix JSON Tab Escaping and Anonymous Object Serialization

## Status: COMPLETED

## Failing Tests Fixed
- `generate_json_escape_tab` - Tab character now escaped as `\u0009`
- `generate_json_anon_obj` - Anonymous objects return `E_INVARG`
- `generate_json_anon_obj_common` - Anonymous objects return `E_INVARG` (common mode)
- `generate_json_anon_obj_embedded` - Anonymous objects return `E_INVARG` (embedded mode)

## Changes Made

### File: `builtins/json.go`

#### 1. Anonymous Object Detection (Lines 107-115)
Added check for anonymous objects before serialization:
```go
case types.ObjValue:
    // Anonymous objects cannot be serialized to JSON
    if val.IsAnonymous() {
        return nil, types.E_INVARG
    }
    if embeddedTypes {
        return fmt.Sprintf("#%d|obj", val.ID()), types.E_NONE
    }
    return fmt.Sprintf("#%d", val.ID()), types.E_NONE
```

**Why:** Anonymous objects (created with `create($nothing, 1)`) cannot be meaningfully serialized to JSON since they have no persistent identity. ToastStunt returns `E_INVARG` for these.

#### 2. Tab Character Escaping (Lines 331-361)
Replaced `uppercaseUnicodeEscapes()` with `normalizeJSONEscapes()`:
```go
// normalizeJSONEscapes converts JSON escapes to match MOO behavior:
// - \uxxxx -> \uXXXX (uppercase hex)
// - \t -> \u0009 (tab as unicode escape)
func normalizeJSONEscapes(s string) string {
    var result strings.Builder
    i := 0
    for i < len(s) {
        if i+1 < len(s) && s[i] == '\\' {
            next := s[i+1]
            if next == 'u' && i+5 < len(s) {
                // Found \u, check for 4 hex digits and uppercase them
                hex := s[i+2 : i+6]
                result.WriteString("\\u")
                result.WriteString(strings.ToUpper(hex))
                i += 6
            } else if next == 't' {
                // Convert \t to \u0009
                result.WriteString("\\u0009")
                i += 2
            } else {
                // Other escape sequences pass through unchanged
                result.WriteByte(s[i])
                i++
            }
        } else {
            result.WriteByte(s[i])
            i++
        }
    }
    return result.String()
}
```

**Why:** Go's standard `json.Marshal` escapes tab characters as `\t`, but MOO/ToastStunt uses `\u0009` for tabs. This post-processing step converts the escape sequence to match expected behavior.

## Test Results

### Manual Testing
```bash
# Tab escaping
./moo_client.exe -port 9300 -cmd "connect wizard" -cmd "; return generate_json([\"foo\" -> \"bar~09baz\"]);"
# Result: {1, "{\"foo\":\"bar\\u0009baz\"}"}  ✓ Correct

# Anonymous object
./moo_client.exe -port 9300 -cmd "connect wizard" -cmd "; return generate_json(create(\$nothing, 1));"
# Result: {2, {E_INVARG, "", 0}}  ✓ Correct
```

### Conformance Test Results
```
cd /c/Users/Q/code/cow_py
uv run pytest tests/conformance/ -k "json" --transport socket --moo-port 9300 -v

==================== 131 passed, 1348 deselected in 0.98s =====================
```

All 131 JSON tests now pass, including the 4 previously failing tests.

## Technical Details

### Tab Escaping Issue
- **Problem:** Go's `json.Marshal()` produces `\t` for tab characters (ASCII 0x09)
- **Expected:** MOO/ToastStunt produces `\u0009` (Unicode escape)
- **Solution:** Post-process the JSON output to convert `\t` → `\u0009`

### Anonymous Object Issue
- **Problem:** Anonymous objects created with `create($nothing, 1)` have no persistent identity
- **Expected:** Return `E_INVARG` when attempting to serialize to JSON
- **Detection:** Use `ObjValue.IsAnonymous()` method to check the object's `anonymous` flag
- **Solution:** Check for anonymous objects early in `mooToJSON()` and return `E_INVARG`

## Root Cause Analysis

### Why Tab Needed Special Handling
The MOO binary escape format `~09` (tab) is decoded to an actual tab byte before JSON marshaling. Go's JSON marshaler then uses `\t` which is valid JSON but doesn't match MOO's expectation of `\u0009`. This difference matters for round-tripping and compatibility with existing MOO code.

### Why Anonymous Objects Need Rejection
Anonymous objects are transient - they exist only for the duration of a task execution. They have no persistent object number that can be meaningfully serialized and later deserialized. Attempting to serialize them would produce output like `"#12"` which wouldn't refer to the same object if parsed later.

## Verification Against ToastStunt

Used the `toast_oracle` tool to confirm expected behavior:
```bash
# ToastStunt behavior confirmed for both cases
./toast_oracle.exe 'return generate_json(["foo" -> "bar~09baz"]);'
# Returns: {"foo":"bar\u0009baz"}

./toast_oracle.exe 'return generate_json(create($nothing, 1));'
# Returns: E_INVARG
```

## Commit
```
commit 4e3a0ba
Author: [generated by build]
Date:   [timestamp]

    Fix JSON tab escaping and anonymous object serialization

    - Escape tab characters as \u0009 instead of \t in JSON output
    - Return E_INVARG when attempting to serialize anonymous objects
    - All 131 JSON conformance tests now pass
```

## Impact
- No breaking changes - only fixes incorrect behavior
- All existing JSON tests continue to pass
- Brings Barn closer to full ToastStunt compatibility
